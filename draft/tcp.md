---
title: TCP
date: 2017-04-04 23:12:47
tags:
- Java
- Network
toc: true
---
TCP传输控制协议（Transmission Control Protocol）是面向连接的传输层协议，提供可靠的字节流传输。

TCP特点：

* 面向连接的传输层协议
* 可靠传输
* 面向字节流传输
* 全双工通信
 
TCP把连接作为基本的抽象，每个连接两端为两个套接字socket，socket由IP地址+端口号组成。

TCP保证报文按顺序，不重复发送报文，则需要对分组进行编号，以字节为基准。

可靠传输原理

1. 报文确认机制。发送方发送一个报文，接收方在成功接收后会向发送方发送一个确认报文，确认的序号为期望的下一步接收的起始字节编号。接收方接收后便确认该序号之前的字节分组均成功送达。
2. 发送方超时重传。发送方发送一个分组不会立即删除而是缓存该分组，同时设置一个超时计时器，若在超时时间段内未收到接收方发送的确认报文，则会重传该分组；若在时间段内收到确认，则删除该分组缓存。
3. 接收方重复确认。接收方收到重复的报文时，说明确认报文由于丢失未到达发送方，需要重传确认报文，并丢弃该重复报文。

TCP首部

| 2字节   | 2字节 |
|:-------------: |:---------------:|
| 源端口 | 目的端口 |
| 发送序号 | 发送序号 |
| 确认序号 | 确认序号 |
| 数据偏移、标志位 | 接受窗口 |
| 检验和 | 紧急指针 |
| 选项 | 填充 |

前20字节（至紧急指针）为固定格式。

数据偏移：TCP报文中数据在TCP报文的偏移位置，即使报文首部的长度。

标志位：

* URG：紧急标志位，标志有紧急数据需要优先传输，紧急指针有效，紧急指针表示紧急数据的长度，紧急数据之后为普通数据。
* ACK：确认标志位，表示确认为有效。
* PSH：推送标志位，表示该报文需尽快推送给上传应用，不等待至缓存区满。
* RST：复位标志位，表示TCP连接出现严重错误，需重新连接。
* SYN：同步标志位，用于标志建立连接消息。
* FIN：终止标志位，用于标志释放连接消息。

接受窗口：告诉发送方可以接受多长的数据。

检验和：加上伪首部信息（IP源地址，IP目的地址，全零（1字节）+协议号（1字节）+TCP报文长度（2字节）），与整个TCP报文（补零对其）相与得到结果并取反。接收方检验：按相同方式计算结果应全为一。


滑动窗口

TCP发送方维护着一个发送窗口，发送窗口受到拥塞窗口和接收窗口大小的影响，位于发送窗口内的字节数据可以被发送，可包含多个分组，这样可以同时发送多个分组，不需要一个一个发送分组并等待确认，提高了发送效率。

拥塞控制

TCP发送方维护一个拥塞窗口，会根据发送报文的重传情况来判断网络状态，并以此来动态调整拥塞窗口的大小。

* 慢开始和拥塞避免

慢开始算法和拥塞避免算法往往配合使用。

慢开始：该算法有一个门限值，开始时拥塞窗口大小为1（单位为报文段个数），小于门限值时，若没有发生重传，则执行慢开始算法，以两倍的速率增大窗口。

拥塞避免：当到达门限值时，执行拥塞避免算法，拥塞窗口大小增长速率变为每次增加1；若是发生了一次重传，则将门限值设为窗口大小的一半，拥塞窗口设为初始值1，重新开始执行慢开始算法。

* 快重传和快开始

快重传和快开始算法也往往配合使用。

快重传：算法要求接收方每收到一个失序的报文时，如收到M1、M3、M4、M5，就立即向发送方发送之前收到的报文确认（确认M1），以通知发送方中间存在报文丢失。发送方在连续收到三个重复的确认之后，判断M2未送达，则重新发送M2分组。

快开始：发送方连续收到三个确认报文，就将门限值设为窗口大小的一半，并认为网络很可能没有发送拥塞（连续收到三个报文），因此就将拥塞窗口大小直接设置为门限值，执行拥塞避免算法。

